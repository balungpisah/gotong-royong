apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gotong-pack-c-cutover-stage-a
  labels:
    app.kubernetes.io/name: gotong-royong
    app.kubernetes.io/component: monitoring
    gotong.packc.stage: stage-a
spec:
  groups:
    - name: gotong-pack-c-cutover-stage-a
      interval: 30s
      rules:
        - alert: GotongPackCStageAEdgeErrorRatioWarning
          expr: |
            (
              (sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_error"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])) or vector(0)), 1)
            ) > 0.001
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A edge_error ratio is elevated"
            description: "edge_error ratio exceeded 0.1% during baseline stage."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAEdgeErrorRatioCritical
          expr: |
            (
              (sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_error"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])) or vector(0)), 1)
            ) > 0.005
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A edge_error ratio is critical"
            description: "edge_error ratio exceeded 0.5% during baseline stage."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAEdgePartialRatioWarning
          expr: |
            (
              (sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_partial"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])) or vector(0)), 1)
            ) > 0.003
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A edge_partial ratio is elevated"
            description: "edge_partial ratio exceeded 0.3% during baseline stage."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAEdgePartialRatioCritical
          expr: |
            (
              (sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_partial"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])) or vector(0)), 1)
            ) > 0.01
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A edge_partial ratio is critical"
            description: "edge_partial ratio exceeded 1% during baseline stage."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAShadowMismatchWarning
          expr: (sum(increase(gotong_api_feed_involvement_shadow_mismatch_total[30m])) or vector(0)) > 3
          for: 5m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A shadow mismatch growth detected"
            description: "Shadow mismatch increased by more than 3 over 30 minutes."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAShadowMismatchCritical
          expr: (sum(increase(gotong_api_feed_involvement_shadow_mismatch_total[30m])) or vector(0)) > 10
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A shadow mismatch growth is critical"
            description: "Shadow mismatch increased by more than 10 over 30 minutes."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAFeedP95LatencyWarning
          expr: |
            max(gotong_api_http_request_duration_seconds{route="/v1/feed",method="GET",quantile="0.95"}) > 0.18
          for: 15m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A feed p95 latency above SLO"
            description: "GET /v1/feed p95 latency exceeded 180ms."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAFeedP95LatencyCritical
          expr: |
            max(gotong_api_http_request_duration_seconds{route="/v1/feed",method="GET",quantile="0.95"}) > 0.25
          for: 10m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A feed p95 latency is critical"
            description: "GET /v1/feed p95 latency exceeded 250ms."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAFeed5xxRatioWarning
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/feed",method="GET"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/feed",method="GET"}[5m])) or vector(0)), 1)
            ) > 0.01
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A feed 5xx ratio is elevated"
            description: "GET /v1/feed 5xx ratio exceeded 1%."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageAFeed5xxRatioCritical
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/feed",method="GET"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/feed",method="GET"}[5m])) or vector(0)), 1)
            ) > 0.02
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-a
          annotations:
            summary: "Pack C stage A feed 5xx ratio is critical"
            description: "GET /v1/feed 5xx ratio exceeded 2%."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
