apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gotong-chat-attachment-lifecycle
  labels:
    app.kubernetes.io/name: gotong-royong
    app.kubernetes.io/component: monitoring
    gotong.monitoring.domain: chat-attachment
spec:
  groups:
    - name: gotong-chat-attachment-lifecycle
      interval: 30s
      rules:
        - alert: GotongChatAttachmentUpload5xxRatioWarning
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/chat/attachments/upload",method="POST"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/chat/attachments/upload",method="POST"}[5m])) or vector(0)), 1)
            ) > 0.01
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            domain: chat-attachment
          annotations:
            summary: "Chat attachment upload 5xx ratio is elevated"
            description: "Upload 5xx ratio exceeded 1% over 10 minutes."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
        - alert: GotongChatAttachmentUpload5xxRatioCritical
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/chat/attachments/upload",method="POST"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/chat/attachments/upload",method="POST"}[5m])) or vector(0)), 1)
            ) > 0.03
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            domain: chat-attachment
          annotations:
            summary: "Chat attachment upload 5xx ratio is critical"
            description: "Upload 5xx ratio exceeded 3% over 5 minutes."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
        - alert: GotongChatAttachmentUploadP95LatencyWarning
          expr: |
            max(gotong_api_http_request_duration_seconds{route="/v1/chat/attachments/upload",method="POST",quantile="0.95"}) > 0.75
          for: 15m
          labels:
            severity: warning
            service: gotong-api
            domain: chat-attachment
          annotations:
            summary: "Chat attachment upload p95 latency above target"
            description: "Upload p95 latency exceeded 750ms over 15 minutes."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
        - alert: GotongChatAttachmentDownload5xxRatioWarning
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/chat/attachments/:attachment_id/download",method="GET"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/chat/attachments/:attachment_id/download",method="GET"}[5m])) or vector(0)), 1)
            ) > 0.005
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            domain: chat-attachment
          annotations:
            summary: "Chat attachment download gate 5xx ratio is elevated"
            description: "Download-gate 5xx ratio exceeded 0.5% over 10 minutes."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
        - alert: GotongChatAttachmentDownload5xxRatioCritical
          expr: |
            (
              (sum(rate(gotong_api_http_errors_total{route="/v1/chat/attachments/:attachment_id/download",method="GET"}[5m])) or vector(0))
              /
              clamp_min((sum(rate(gotong_api_http_requests_total{route="/v1/chat/attachments/:attachment_id/download",method="GET"}[5m])) or vector(0)), 1)
            ) > 0.02
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            domain: chat-attachment
          annotations:
            summary: "Chat attachment download gate 5xx ratio is critical"
            description: "Download-gate 5xx ratio exceeded 2% over 5 minutes."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
        - alert: GotongChatAttachmentStorageGrowthWarning
          expr: |
            (
              sum(max_over_time(minio_bucket_usage_total_bytes{bucket=~"gotong-royong-evidence.*"}[6h]))
              -
              sum(min_over_time(minio_bucket_usage_total_bytes{bucket=~"gotong-royong-evidence.*"}[6h]))
            ) > 5368709120
          for: 30m
          labels:
            severity: warning
            service: object-storage
            domain: chat-attachment
          annotations:
            summary: "Chat attachment bucket growth is elevated"
            description: "Observed >5GiB growth over 6h in gotong-royong-evidence* buckets."
            runbook: "docs/deployment/chat-attachment-storage-lifecycle-runbook.md"
