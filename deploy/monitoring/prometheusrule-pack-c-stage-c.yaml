apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: gotong-pack-c-cutover-stage-c
  labels:
    app.kubernetes.io/name: gotong-royong
    app.kubernetes.io/component: monitoring
    gotong.packc.stage: stage-c
spec:
  groups:
    - name: gotong-pack-c-cutover-stage-c
      interval: 30s
      rules:
        - alert: GotongPackCStageCEdgeErrorRatioWarning
          expr: |
            (
              sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_error"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])), 1)
            ) > 0.0001
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C edge_error ratio is elevated"
            description: "edge_error ratio exceeded 0.01% during full cutover."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCEdgeErrorRatioCritical
          expr: |
            (
              sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_error"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])), 1)
            ) > 0.0005
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C edge_error ratio is critical"
            description: "edge_error ratio exceeded 0.05% during full cutover."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCEdgePartialRatioWarning
          expr: |
            (
              sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_partial"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])), 1)
            ) > 0.0005
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C edge_partial ratio is elevated"
            description: "edge_partial ratio exceeded 0.05% during full cutover."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCEdgePartialRatioCritical
          expr: |
            (
              sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane="edge_partial"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search"}[5m])), 1)
            ) > 0.002
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C edge_partial ratio is critical"
            description: "edge_partial ratio exceeded 0.2% during full cutover."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCFeedP95LatencyWarning
          expr: |
            histogram_quantile(
              0.95,
              sum(rate(gotong_api_http_request_duration_seconds_bucket{route="/v1/feed",method="GET"}[5m])) by (le)
            ) > 0.18
          for: 15m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C feed p95 latency above SLO"
            description: "GET /v1/feed p95 latency exceeded 180ms."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCFeedP95LatencyCritical
          expr: |
            histogram_quantile(
              0.95,
              sum(rate(gotong_api_http_request_duration_seconds_bucket{route="/v1/feed",method="GET"}[5m])) by (le)
            ) > 0.25
          for: 10m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C feed p95 latency is critical"
            description: "GET /v1/feed p95 latency exceeded 250ms."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCFeed5xxRatioWarning
          expr: |
            (
              sum(rate(gotong_api_http_errors_total{route="/v1/feed",method="GET"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_http_requests_total{route="/v1/feed",method="GET"}[5m])), 1)
            ) > 0.01
          for: 10m
          labels:
            severity: warning
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C feed 5xx ratio is elevated"
            description: "GET /v1/feed 5xx ratio exceeded 1%."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCFeed5xxRatioCritical
          expr: |
            (
              sum(rate(gotong_api_http_errors_total{route="/v1/feed",method="GET"}[5m]))
              /
              clamp_min(sum(rate(gotong_api_http_requests_total{route="/v1/feed",method="GET"}[5m])), 1)
            ) > 0.02
          for: 5m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C feed 5xx ratio is critical"
            description: "GET /v1/feed 5xx ratio exceeded 2%."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
        - alert: GotongPackCStageCFallbackLaneNonZero
          expr: |
            sum(rate(gotong_api_feed_involvement_lane_requests_total{endpoint=~"feed|search",lane=~"fallback|legacy"}[5m])) > 0
          for: 15m
          labels:
            severity: critical
            service: gotong-api
            pack_c_stage: stage-c
          annotations:
            summary: "Pack C stage C fallback or legacy lane still active"
            description: "Fallback or legacy involvement lane remained non-zero for 15m in full cutover."
            runbook: "docs/deployment/feed-involvement-fallback-removal-runbook.md"
