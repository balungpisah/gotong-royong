{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://gotong-royong.internal/schema/edgepod-EP-02.schema.json",
  "title": "Edge-Pod contract for EP-02",
  "endpoint_id": "EP-02",
  "path": "/api/v1/edge-pod/ai/02/redaction",
  "method": "POST",
  "definitions": {
    "Actor": {
      "type": "object",
      "required": [
        "user_id",
        "platform_user_id",
        "role"
      ],
      "properties": {
        "user_id": {
          "type": "string",
          "minLength": 1
        },
        "platform_user_id": {
          "type": "string",
          "minLength": 1
        },
        "role": {
          "type": "string",
          "enum": [
            "member",
            "admin",
            "moderator",
            "humas",
            "bendahara",
            "pic",
            "system"
          ]
        }
      },
      "additionalProperties": false
    },
    "GeoPoint": {
      "type": "object",
      "required": [
        "lat",
        "lng"
      ],
      "properties": {
        "lat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90
        },
        "lng": {
          "type": "number",
          "minimum": -180,
          "maximum": 180
        }
      },
      "additionalProperties": true
    },
    "BaseRequest": {
      "type": "object",
      "required": [
        "request_id",
        "correlation_id",
        "actor",
        "trigger",
        "payload_version"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "pattern": "^req_[A-Za-z0-9_-]{8,}$"
        },
        "correlation_id": {
          "type": "string",
          "minLength": 4
        },
        "actor": {
          "$ref": "#/definitions/Actor"
        },
        "session_id": {
          "type": "string"
        },
        "trigger": {
          "type": "string",
          "enum": [
            "user_action",
            "timer",
            "webhook",
            "async_batch"
          ]
        },
        "payload_version": {
          "type": "string"
        },
        "privacy_level": {
          "type": "string",
          "enum": [
            "open",
            "l1",
            "l2",
            "vault"
          ]
        }
      },
      "additionalProperties": true
    },
    "SuccessEnvelope": {
      "type": "object",
      "required": [
        "request_id",
        "result_version",
        "output"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "minLength": 1
        },
        "result_version": {
          "type": "string",
          "pattern": "^v\\d+\\.\\d+\\.\\d+$"
        },
        "output": {
          "type": "object"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "reason_code": {
          "type": "string"
        },
        "actor_context": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "ErrorEnvelope": {
      "type": "object",
      "required": [
        "request_id",
        "result_version",
        "error"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "minLength": 1
        },
        "result_version": {
          "type": "string",
          "pattern": "^v\\d+\\.\\d+\\.\\d+$"
        },
        "error": {
          "type": "object",
          "required": [
            "code",
            "message",
            "retryable"
          ],
          "properties": {
            "code": {
              "type": "string",
              "enum": [
                "MODEL_UNAVAILABLE",
                "INVALID_INPUT",
                "TIMEOUT",
                "SCHEMA_VIOLATION",
                "RETRYABLE_TRANSIENT",
                "POLICY_BLOCK"
              ]
            },
            "message": {
              "type": "string",
              "minLength": 1
            },
            "retryable": {
              "type": "boolean"
            },
            "details": {
              "type": "object",
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    }
  },
  "request_schema": {
    "allOf": [
      {
        "$ref": "#/definitions/BaseRequest"
      },
      {
        "type": "object",
        "required": [
          "text",
          "text_format",
          "user_id",
          "context_summary"
        ],
        "properties": {
          "text": {
            "type": "string",
            "minLength": 1
          },
          "text_format": {
            "type": "string",
            "enum": [
              "plain",
              "markdown"
            ]
          },
          "user_id": {
            "type": "string",
            "minLength": 1
          },
          "context_summary": {
            "type": "string",
            "minLength": 1
          },
          "privacy_level": {
            "type": "string",
            "enum": [
              "open",
              "l1",
              "l2",
              "vault"
            ]
          },
          "allow_redaction": {
            "type": "boolean"
          }
        }
      }
    ]
  },
  "success_response_schema": {
    "allOf": [
      {
        "$ref": "#/definitions/SuccessEnvelope"
      },
      {
        "required": [
          "output"
        ],
        "properties": {
          "output": {
            "type": "object",
            "required": [
              "redacted_text",
              "redaction_count",
              "needs_manual_review"
            ],
            "properties": {
              "redacted_text": {
                "type": "string"
              },
              "redaction_count": {
                "type": "integer",
                "minimum": 0
              },
              "redacted_items": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": [
                    "kind",
                    "start",
                    "end",
                    "value"
                  ],
                  "properties": {
                    "kind": {
                      "type": "string"
                    },
                    "start": {
                      "type": "integer",
                      "minimum": 0
                    },
                    "end": {
                      "type": "integer",
                      "minimum": 1
                    },
                    "value": {
                      "type": "string"
                    }
                  },
                  "additionalProperties": false
                }
              },
              "needs_manual_review": {
                "type": "boolean"
              },
              "reason_code": {
                "type": "string"
              }
            }
          }
        }
      }
    ]
  },
  "error_response_schema": {
    "$ref": "#/definitions/ErrorEnvelope"
  }
}
