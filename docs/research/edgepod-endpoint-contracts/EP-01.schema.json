{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://gotong-royong.internal/schema/edgepod-EP-01.schema.json",
  "title": "Edge-Pod contract for EP-01",
  "endpoint_id": "EP-01",
  "path": "/api/v1/edge-pod/ai/01/classification",
  "method": "POST",
  "definitions": {
    "Actor": {
      "type": "object",
      "required": [
        "user_id",
        "platform_user_id",
        "role"
      ],
      "properties": {
        "user_id": {
          "type": "string",
          "minLength": 1
        },
        "platform_user_id": {
          "type": "string",
          "minLength": 1
        },
        "role": {
          "type": "string",
          "enum": [
            "member",
            "admin",
            "moderator",
            "humas",
            "bendahara",
            "pic",
            "system"
          ]
        }
      },
      "additionalProperties": false
    },
    "GeoPoint": {
      "type": "object",
      "required": [
        "lat",
        "lng"
      ],
      "properties": {
        "lat": {
          "type": "number",
          "minimum": -90,
          "maximum": 90
        },
        "lng": {
          "type": "number",
          "minimum": -180,
          "maximum": 180
        }
      },
      "additionalProperties": true
    },
    "BaseRequest": {
      "type": "object",
      "required": [
        "request_id",
        "correlation_id",
        "actor",
        "trigger",
        "payload_version"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "pattern": "^req_[A-Za-z0-9_-]{8,}$"
        },
        "correlation_id": {
          "type": "string",
          "minLength": 4
        },
        "actor": {
          "$ref": "#/definitions/Actor"
        },
        "session_id": {
          "type": "string"
        },
        "trigger": {
          "type": "string",
          "enum": [
            "user_action",
            "timer",
            "webhook",
            "async_batch"
          ]
        },
        "payload_version": {
          "type": "string"
        },
        "privacy_level": {
          "type": "string",
          "enum": [
            "open",
            "l1",
            "l2",
            "vault"
          ]
        }
      },
      "additionalProperties": true
    },
    "SuccessEnvelope": {
      "type": "object",
      "required": [
        "request_id",
        "result_version",
        "output"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "minLength": 1
        },
        "result_version": {
          "type": "string",
          "pattern": "^v\\d+\\.\\d+\\.\\d+$"
        },
        "output": {
          "type": "object"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "reason_code": {
          "type": "string"
        },
        "actor_context": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "ErrorEnvelope": {
      "type": "object",
      "required": [
        "request_id",
        "result_version",
        "error"
      ],
      "properties": {
        "request_id": {
          "type": "string",
          "minLength": 1
        },
        "result_version": {
          "type": "string",
          "pattern": "^v\\d+\\.\\d+\\.\\d+$"
        },
        "error": {
          "type": "object",
          "required": [
            "code",
            "message",
            "retryable"
          ],
          "properties": {
            "code": {
              "type": "string",
              "enum": [
                "MODEL_UNAVAILABLE",
                "INVALID_INPUT",
                "TIMEOUT",
                "SCHEMA_VIOLATION",
                "RETRYABLE_TRANSIENT",
                "POLICY_BLOCK"
              ]
            },
            "message": {
              "type": "string",
              "minLength": 1
            },
            "retryable": {
              "type": "boolean"
            },
            "details": {
              "type": "object",
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    }
  },
  "request_schema": {
    "allOf": [
      {
        "$ref": "#/definitions/BaseRequest"
      },
      {
        "type": "object",
        "required": [
          "text",
          "seed_candidate_id"
        ],
        "properties": {
          "text": {
            "type": "string",
            "minLength": 1
          },
          "seed_candidate_id": {
            "type": "string",
            "minLength": 1
          },
          "location": {
            "$ref": "#/definitions/GeoPoint"
          },
          "conversation_context": {
            "type": "object",
            "additionalProperties": true
          },
          "suggested_track": {
            "type": "string"
          },
          "seed_type_hint": {
            "type": "string"
          }
        }
      }
    ]
  },
  "success_response_schema": {
    "allOf": [
      {
        "$ref": "#/definitions/SuccessEnvelope"
      },
      {
        "required": [
          "output"
        ],
        "properties": {
          "manual_required": {
            "type": "boolean"
          },
          "output": {
            "type": "object",
            "required": [
              "track",
              "track_confidence",
              "seed_type",
              "seed_confidence",
              "ambiguity_flag"
            ],
            "properties": {
              "track": {
                "type": "string"
              },
              "track_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "seed_type": {
                "type": "string"
              },
              "seed_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "esco_skills": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": [
                    "uri",
                    "score"
                  ],
                  "properties": {
                    "uri": {
                      "type": "string"
                    },
                    "score": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  }
                }
              },
              "ambiguity_flag": {
                "type": "boolean"
              },
              "alternative_track": {
                "type": "string"
              },
              "alternative_confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "reasoning": {
                "type": "string"
              }
            }
          }
        }
      }
    ]
  },
  "error_response_schema": {
    "$ref": "#/definitions/ErrorEnvelope"
  }
}
