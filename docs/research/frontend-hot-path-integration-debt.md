# Frontend Hot-Path Integration Debt

Last updated: 2026-02-27

This file tracks known debt introduced intentionally during staged API cutover for feed/chat/notifications.

For non-hot-path service cutover (`triage`, `signal`, `group`), see:
- `docs/research/frontend-service-api-cutover-backlog.md`

## Open Debt

| Debt ID | Area | Current Behavior | Risk | Required Follow-up |
|---|---|---|---|---|
| `TRIAGE-E2E-003` | Triage payload render e2e stabilization | Deterministic hooks landed (`data-testid` on triage shell/panel/opener/input/send/reset/chips + operator-preview containers), and payload spec selectors were migrated, but the suite remains `describe.skip`: in Playwright headless, the visible masonry triage shell can remain non-interactive (`data-hydrated=false`) while interaction handlers attach to a different render instance, causing opener/chip flows to flake/time out. | Medium (payload rendering regression could slip until harness can target the interactive triage instance deterministically) | Add a first-class test harness target for triage in feed (single interactive instance with stable open-state + hydration contract, or dedicated test route), then re-enable `apps/web/tests/e2e/triage-payload-render.spec.ts` and require it in `bun run test:e2e` gate. |
| `CHAT-API-004` | Attachment lifecycle policy automation | Local readiness is green: `hot_path_rollout.sh` dry-run (with chat alerts/lifecycle enabled), `just release-gates-surreal`, and `just chat-attachment-alerts-verify` all pass; latest artifacts are refreshed (`docs/research/hot-path-rollout-latest.md`, `docs/research/release-gates-surreal-latest.md`, `docs/research/chat-attachment-*.md`). Branch protection live check now passes for `balungpisah/gotong-royong` (`docs/research/branch-protection-surreal-release-gates-latest.md`). Remaining gap is live staging/prod alert rule apply + lifecycle rollout on real clusters. | Low-Medium (object growth over time) | Execute the strict checklist in `docs/deployment/chat-attachment-storage-lifecycle-runbook.md` (`Strict Staging/Prod Checklist` section): run `just hot-path-rollout monitoring http://<prometheus-host>:9090 60s false true true true true` in staging and production, archive environment-specific evidence artifacts, and keep `docs/research/branch-protection-surreal-release-gates-latest.md` as attached proof for the branch-protection gate. Operator handoff summary: `docs/research/chat-api-004-next-actions-latest.md`. |
| `USER-API-004` | Markov profile upstream dependency (local live mode) | Frontend live API flows can run without Markov, but `/v1/tandang/me/profile` and `/v1/tandang/users/:user_id/profile` return `500` when `MARKOV_READ_PLATFORM_TOKEN` (and base URL) are not configured. This is intentionally deferred for local-only development while core cutover slices are landed. | Medium (profile card/deep-link data incomplete in local live runs) | When ready for full local parity, provision Markov credentials in dev env (`MARKOV_READ_PLATFORM_TOKEN`, `MARKOV_READ_BASE_URL`), validate `/v1/tandang/*/profile` returns `200`, then re-run `just web-test-e2e-live-api <target>` and update `docs/research/frontend-live-api-proxy-smoke-latest.md` with evidence. |
| `FEED-SEED-001` | Seeded taxonomy card source cutover | Seeded taxonomy coverage is currently driven by frontend fixtures with optional `payload.dev_meta` mapping in place for backend compatibility. This is intentional while operator/Markov-integrated feed generation is deferred. | Low (dev-only visibility), Medium (if teams assume fixture behavior equals production behavior) | Add backend seed ingestion path in local/staging (`seed_origin=db`), return `payload.dev_meta` from `/v1/feed`, and validate dev-only seed filters/badges still work without using `entity_tags` semantics. Keep production payloads omitting `dev_meta`. |

## Closed Debt

| Debt ID | Area | Resolution | Closed On |
|---|---|---|---|
| `CONTRACT-LOCK-005` | Data/program/stempel contract defaults | Locked canonical contract defaults for `kind=data` taxonomy + structured `program_refs[]` + backend-authoritative stempel lifecycle (`propose/objections/finalize`) with default guardrails (`24h`, min `3` participants). Backend now emits `taxonomy/program_refs/stempel_state` in triage + witness-create, and opens `impact_verification` when stempel successfully locks. | 2026-02-26 |
| `TRIAGE-CONTRACT-003` | Triage contract drift (docs vs runtime) | Established single runtime source of truth (`docs/research/contracts/triage-witness-feed-contract-v1.md`), marked legacy contract docs as superseded/archived, enforced backend `triage.v1` checks, made witness-create session-authoritative, and removed frontend synthetic witness-feed injection in favor of backend-created stream items. | 2026-02-26 |
| `WITNESS-UX-001` | Stempel backend alignment | Disabled simulated stempel flow pending backend checkpoint-evaluation contract: removed synthetic message injection from home and component-gallery witness panels, and gated Stempel action rendering so chat only shows the button when a real handler is wired. | 2026-02-25 |
| `FEED-PREF-001` | Feed follow/monitor preference persistence | Added persisted preference writes and read overlays for feed hot-path: backend endpoints (`POST /v1/feed/preferences/monitor/:witness_id`, `POST /v1/feed/preferences/follow/:entity_id`) now store preferences (Surreal migration `0031_feed_preference_schema` + in-memory fallback), feed/suggestion reads merge per-user monitor/follow state, and frontend `FeedStore` now persists optimistic toggles through `ApiFeedService`. | 2026-02-26 |
| `NOTIF-API-002` | Notification deep-link target mapping | Frontend notification mapping now preserves navigation context from API (`witness_id` + sanitized `target_path`) and notification click handler resolves canonical local targets (`target_path` first, `/saksi/:witness_id` fallback), so cards can reliably deep-link to witness detail. | 2026-02-26 |
| `GOTONG-WORKER-LOCAL-001` | Webhook worker dequeue payload (local Redis queue) | Fixed retry queue payload loss: worker now uses a new retry job ID per attempt (`next_retry_job_id`) before enqueue+ack, preventing `ack(current_job_id)` from deleting payload of the scheduled retry entry. Live local smoke (`gotong-api` + `gotong-worker` + Docker Redis/Surreal) confirms outbox attempts advance (`attempts >= 1`), retry payload stays queued (`delayed=1`, `payload=1`), and no `missing payload for job_id` dequeue errors. | 2026-02-25 |
| `GOTONG-WEBHOOK-LOCAL-001` | Gotong webhook outbox persistence (local Surreal v3) | Fixed Surreal v3 outbox persistence by patching `SurrealWebhookOutboxRepository` datetime-safe writes/reads (including nullable `next_attempt_at` projection), adding migration/check pair `0030_webhook_payload_flexible` for nested webhook payload objects, and validating live local API flow (`create_contribution` + `submit_vouch`) persists outbox rows without datetime coercion errors. | 2026-02-25 |
| `TANDANG-LOCAL-001` | Trusted webhook auto-link (local Tandang DB) | Fixed upstream Tandang trusted auto-link order (`users` created before identity-hash insert), normalized ingestion to avoid storing duplicate-prefixed platform IDs, and added read compatibility for legacy prefixed links. Live verification now shows fresh unlinked Gotong user moving `404 -> 200` on `/v1/tandang/me/profile` after first valid webhook without manual SQL seeding. | 2026-02-25 |
| `FEED-API-001` | Feed suggestions | Added authenticated backend endpoint `GET /v1/feed/suggestions` that aggregates entity tags from visible feed rows; wired `ApiFeedService.listSuggestions()` to consume it and map into `FollowableEntity[]`. | 2026-02-25 |
| `CHAT-API-002` | Chat author profile | Added chat message `author` snapshot in `GET /v1/chat/threads/:thread_id/messages`, `/poll`, and `POST /messages/send`; frontend `ApiWitnessService` now uses snapshot name/role/tier/avatar instead of defaulting to raw `author_id`. | 2026-02-25 |
| `CHAT-API-001` | Chat attachments | Added attachment upload + signed download URL flow (`POST /v1/chat/attachments/upload`, `GET /v1/chat/attachments/:attachment_id/download`) and wired `ApiWitnessService.sendMessage()` to upload files first, then send URL-bearing attachment objects in chat payload. | 2026-02-25 |
| `CHAT-API-003` | Attachment object storage backend | Added configurable chat attachment storage backend (`CHAT_ATTACHMENT_STORAGE_BACKEND=auto|local|s3`). In `s3`/healthy `auto` mode, uploads are stored in S3/MinIO and download endpoint returns short-lived presigned object URL redirects; local disk remains fallback for test/dev resilience. | 2026-02-25 |
| `HOTPATH-UX-001` | Feed/chat/notifications degraded states | Added explicit degraded UX handling for API failures: feed and witness-detail surfaces now show retryable error banners (with stale-data preservation when available), notifications route now has retryable error/empty-failure states, and chat triage submit now preserves draft text/attachments on failure with inline retry affordance instead of appending false-success AI bubbles. | 2026-02-25 |
| `HOTPATH-UX-002` | Signal chip degraded state | Added per-witness signal error tracking in `SignalStore`, plus inline retryable failure surface in `SignalChipBar` so failed `saksi/perlu_dicek` writes are visible and recoverable without hard refresh. | 2026-02-25 |
| `HOTPATH-UX-003` | Signal chip live-state reflection | Feed cards now merge API-refreshed signal relation/count (`witnessed`, `flagged`, `witness_count`, `flags`) from `SignalStore` into card props immediately after chip actions, while preserving non-signal social metrics (`dukung_count`, vouch counters) and triggering auto-monitor relation updates on successful chip actions. | 2026-02-25 |
| `HOTPATH-E2E-001` | Live frontendâ†’API proxy verification | Added opt-in Playwright live mode (`PLAYWRIGHT_LIVE_API=true`) and smoke spec (`apps/web/tests/e2e/live-api-proxy.spec.ts`) that bootstraps a real auth token via `POST /v1/auth/signup`, then asserts frontend shell requests `/v1/auth/me`, `/v1/feed`, `/v1/notifications` through Vite proxy with successful `200` responses observed. Added runnable entrypoints: `bun run test:e2e:live-api` and `just web-test-e2e-live-api`. | 2026-02-25 |
| `GROUP-API-001` | Group service cutover | Added `/v1/groups*` lifecycle endpoints (create/list/detail/update/join/request/approve/reject/invite/leave/member role/remove) and wired `ApiGroupService` behind `PUBLIC_GR_USE_API_GROUP` with mock fallback and unit/integration tests. | 2026-02-25 |
| `GROUP-API-002` | Group persistence | Replaced in-memory API `groups` map with `GroupRepository` port + in-memory/Surreal implementations, added read-model migration/check (`0029_group_read_model_schema`), and validated on live dev DB (`just db-migrate`, `just db-check`, `just release-gates-surreal`). | 2026-02-25 |
| `USER-API-001` | User non-self profile cutover | Added backend endpoint `GET /v1/tandang/users/:user_id/profile` and wired `ApiUserService.getProfile()` / `getTandangProfile()` to API-backed non-self reads instead of always deferring to mock services. | 2026-02-25 |
| `USER-API-002` | Non-self profile route + e2e | Added frontend route `/profil/:user_id` backed by `UserStore.loadTandangProfile(userId)` and Playwright coverage (`apps/web/tests/e2e/profile-non-self-api.spec.ts`) that verifies request to `/v1/tandang/users/:user_id/profile`. | 2026-02-25 |
| `USER-API-003` | Profile deep-link consistency | Wired non-self profile deep-links from feed member avatar stack and chat/witness author surfaces to `/profil/:user_id`, and expanded Playwright coverage to validate click-through flow reaches `/v1/tandang/users/:user_id/profile`. | 2026-02-25 |
